# Feature Specification: 処方薬管理MVP

**Feature Branch**: `001-build-medication-mvp`  
**Created**: 2026-01-25  
**Status**: Draft  
**Input**: User description: "処方薬管理アプリを作る（MVPは2アプリ構成）。狙い：飲み忘れを減らし、服薬実績を家族が把握できるようにする。残り日数・残薬切れの不安を減らす。本人（高齢者）が迷わず「通知→飲んだ反応」だけできるUIにする。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 連携と服用反応 (Priority: P1)

家族が薬・スケジュール・在庫を登録し、連携コードを発行する。本人はコードを入力して紐付け、
通知を受け取り、ワンタップで服用済みにできる。

**Why this priority**: 本人が迷わず反応できる体験と家族の基本管理がMVPの核だから

**Independent Test**: 家族が薬を1件登録し連携コードを発行、本人が紐付け後に「服用済み」を
1回記録できることを確認できる

**Acceptance Scenarios**:

1. **Given** 家族が薬・スケジュール・在庫を登録済み、**When** 連携コードを発行し本人が入力する、
   **Then** 本人アプリに今日の服薬予定が表示される
2. **Given** 本人アプリに今日の服薬予定が表示されている、**When** 本人がワンタップで反応する、
   **Then** 服用済みとして記録され家族側で確認できる

---

### User Story 2 - 服用履歴の把握 (Priority: P2)

家族が本人の服用履歴を一覧とカレンダーで確認できる。

**Why this priority**: 家族が服薬状況を把握できることが主要目的のため

**Independent Test**: 服用記録が数件ある状態で、一覧とカレンダーの両方で履歴を閲覧できる

**Acceptance Scenarios**:

1. **Given** 服用記録が存在する、**When** 家族が履歴一覧を開く、**Then** いつ・何を飲んだかが
   時系列で表示される
2. **Given** 服用記録が存在する、**When** 家族がカレンダー表示を開く、**Then** 日付ごとに
   服用状況が確認できる

---

### User Story 3 - 在庫と残薬警告 (Priority: P3)

家族が残り錠数を管理でき、残り日数と警告が表示される。

**Why this priority**: 残薬切れの不安を減らすために必要

**Independent Test**: 薬の在庫を登録し、数回の服用記録後に残り日数と警告が表示される

**Acceptance Scenarios**:

1. **Given** 在庫と服用回数が登録されている、**When** 服用が記録される、**Then** 残り錠数と
   残り日数が更新される
2. **Given** 残り日数が警告しきい値以下になる、**When** 家族が在庫画面を開く、
   **Then** 警告が明確に表示される

---

### Edge Cases

- 連携コードが期限切れ、または誤入力された場合はどうなるか
- 本人がオフラインで複数回反応した場合の同期と重複処理
- 服用時間帯が日付境界をまたぐ場合（深夜帯など）
- 通知が届かなかった場合の代替導線
- 在庫がマイナスになりそうな場合の扱い

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 家族は薬を登録・編集・削除できる（名称、用量、服用回数、時間、開始、終了または継続、メモ）
- **FR-002**: 家族は薬ごとに在庫（残り錠数）を登録・更新できる
- **FR-003**: システムは服用回数と在庫から残り日数を算出し、警告を表示する
- **FR-004**: 家族は連携コードを発行でき、本人はコード入力で紐付けできる（MVPはこの方式のみ）
- **FR-004a**: 本人はログイン不要で連携コードによる紐付け後、短期トークン（更新あり）で利用する
- **FR-004b**: 連携コードは6桁数字で10分有効の使い捨てとする
- **FR-005**: 本人は今日の服薬予定を時系列で確認できる
- **FR-006**: 本人は各服薬予定に対してワンタップで「服用済み」を記録できる
- **FR-006a**: 本人は自分の服用履歴を一覧とカレンダーで閲覧できる
- **FR-007**: 家族は本人の服用履歴を一覧で確認できる
- **FR-008**: 家族は本人の服用履歴をカレンダーで確認できる
- **FR-009**: システムは本人への通知を送信し、本人が反応できる導線を提供する
- **FR-009a**: MVPの通知はローカル通知のみとする
- **FR-010**: 本人がオフラインでも服用反応を記録でき、オンライン復帰時に同期される
- **FR-011**: 初回導線は家族が一括設定し、本人はコード入力のみで開始できる
- **FR-012**: 家族と本人の権限は分離され、本人側から管理情報を編集できない

### Key Entities *(include if feature involves data)*

- **FamilyUser**: 家族アプリの利用者
- **Patient**: 本人（服薬対象者）
- **LinkCode**: 家族と本人を紐付ける一時コード
- **Medication**: 薬の基本情報と服用ルール
- **DoseSchedule**: 服用回数と時間帯の予定
- **DoseEvent**: 実際の服用記録（予定と実績の紐付け）
- **InventoryRecord**: 在庫と残り日数の計算元データ
- **Notification**: 本人への服薬通知と反応導線

## Security & Privacy Requirements *(mandatory)*

- **SP-001**: 服薬データへのアクセスは家族と本人の最小権限に限定する
- **SP-002**: 収集・保存する個人データはMVP機能に必要な範囲に限定する
- **SP-003**: 服薬データは保存時・送受信時に保護される
- **SP-004**: 連携コードは使い捨てとし、有効期限を設ける
- **SP-005**: 家族アプリは個人アカウントでログインが必須
- **SP-006**: 本人は自分の服薬予定の閲覧と服用結果の作成/更新に加え、履歴の閲覧のみ許可する
- **SP-007**: 連携コードは6桁数字で10分有効、使用後は失効する

## API Contract & Decoupling *(mandatory)*

- **AC-001**: 家族/本人/サーバ/DBの境界に関する契約を明文化する
- **AC-002**: 連携、薬管理、履歴、在庫のAPIは入力/出力とエラーを明記する
- **AC-003**: 契約変更時は互換性と移行方針を記載する

## Observability *(mandatory)*

- **OB-001**: 主要なエラーは再現手順と必要なコンテキストを含むログを残す
- **OB-002**: 同期失敗や重複記録などの異常は判別可能なログを残す

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 家族が初回設定（薬・スケジュール・在庫・連携コード発行）を10分以内に完了できる
- **SC-002**: 本人が「通知→服用済み反応」まで30秒以内に完了できる
- **SC-003**: オンライン時、本人の服用反応が5分以内に家族の履歴に反映される
- **SC-004**: 服用予定の90%以上で本人が正しく反応できる（操作ミス率10%未満）
- **SC-005**: 残薬警告が表示される薬について、警告表示から残薬切れまで3日以上の猶予がある

## Scope & Assumptions

- MVPは家族1アカウントと本人1名のペアを前提とする
- 家族は複数の薬を管理できる
- 服用予定は日単位で管理され、本人の端末時刻を基準とする
- 通知の配信はベストエフォートであり、未着時はアプリ内から確認できる
- MVPの通知はローカル通知のみで運用する

## Out of Scope (MVP)

- 未服用アラートの高度化
- 複数本人の切替
- 受診日提案

## Clarifications

### Session 2026-01-25

- Q: 家族アプリの認証方式（ログイン要否） → A: 家族はログイン必須（個人アカウント）
- Q: 本人アプリの認証・セッション方式 → A: ログイン不要、連携コード後に短期トークン（更新あり）
- Q: 権限（RLS）で本人に許可する操作範囲 → A: 服薬予定閲覧、服用結果の作成/更新、履歴閲覧のみ
- Q: 連携コード仕様（桁数/期限/使い回し） → A: 6桁数字、10分有効、使い捨て
- Q: 通知方式（MVP） → A: ローカル通知のみ
